<!doctype html>

<html lang="en-us">

<head>
  <title>nonocast</title>
  <meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="description" content="The HTML5 Herald" />
<meta name="author" content="nonocast" /><meta property="og:title" content="Unit Test: Sinon" />
<meta property="og:description" content="Standalone test spies, stubs and mocks for JavaScript.
Works with any unit testing framework." />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://nonocast.cn/posts/unit-test-sinon/" />
<meta property="article:published_time" content="2020-01-31T16:57:00+08:00" />
<meta property="article:modified_time" content="2020-01-31T16:57:00+08:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Unit Test: Sinon"/>
<meta name="twitter:description" content="Standalone test spies, stubs and mocks for JavaScript.
Works with any unit testing framework."/>

<meta name="generator" content="Hugo 0.62.0" />
    

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css" integrity="sha256-l85OmPOjvil/SOvVt3HnSSjzF1TUMyT9eV0c2BzEGzU=" crossorigin="anonymous" />
  <link rel="stylesheet" href="http://nonocast.cn/fontawesome/css/all.min.css" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto+Slab|Ruda" />
  <link rel="stylesheet" type="text/css" href="/css/styles.css" /></head>

<body>
  <div id="container">
    <header>
      <h1>
                <a href="/">nonocast</a>
            </h1>

      <ul id="social-media">
             <li>
               <a href="https://github.com/nonocast" title="GitHub">
               <i class="fab fa-github fa-lg"></i>
               </a>
             </li>
             <li>
               <a href="https://twitter.com/@nonocast" title="Twitter">
               <i class="fab fa-twitter fa-lg"></i>
               </a>
             </li>
      </ul>
      
    </header>

    
<nav>
    <ul>
        
    </ul>
</nav>

    <main>




<article>

    <h1>Unit Test: Sinon</h1>

    
        <aside>
    <ul>
        <li>
            <time class="post-date" datetime="2020-01-31T16:57:00&#43;08:00">Jan 31, 2020</time>
        </li>
        

        

        <li>2 minutes read</li>
    </ul>
</aside>

    

    <p>Standalone test spies, stubs and mocks for JavaScript.
Works with any unit testing framework.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#a6e22e">require</span>(<span style="color:#e6db74">&#34;chai&#34;</span>).<span style="color:#a6e22e">should</span>();
<span style="color:#66d9ef">const</span> <span style="color:#a6e22e">assert</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">require</span>(<span style="color:#e6db74">&#34;chai&#34;</span>).<span style="color:#a6e22e">assert</span>;
<span style="color:#66d9ef">const</span> <span style="color:#a6e22e">debug</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">require</span>(<span style="color:#e6db74">&#34;debug&#34;</span>)(<span style="color:#e6db74">&#34;test&#34;</span>);
<span style="color:#66d9ef">const</span> <span style="color:#a6e22e">sinon</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">require</span>(<span style="color:#e6db74">&#34;sinon&#34;</span>);
<span style="color:#66d9ef">const</span> <span style="color:#a6e22e">mongoose</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">require</span>(<span style="color:#e6db74">&#34;mongoose&#34;</span>);
<span style="color:#a6e22e">require</span>(<span style="color:#e6db74">&#34;sinon-mongoose&#34;</span>);
<span style="color:#66d9ef">const</span> <span style="color:#a6e22e">AppContext</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">require</span>(<span style="color:#e6db74">&#39;../../src/AppContext&#39;</span>);

<span style="color:#a6e22e">describe</span>.<span style="color:#a6e22e">skip</span>(<span style="color:#e6db74">&#34;hello sinon&#34;</span>, () =&gt; {
  <span style="color:#a6e22e">it</span>(<span style="color:#e6db74">&#34;fake call&#34;</span>, () =&gt; {
    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">fake</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">sinon</span>.<span style="color:#a6e22e">fake</span>();
    <span style="color:#a6e22e">fake</span>();
    <span style="color:#a6e22e">fake</span>.<span style="color:#a6e22e">called</span>.<span style="color:#a6e22e">should</span>.<span style="color:#a6e22e">eq</span>(<span style="color:#66d9ef">true</span>);
    <span style="color:#a6e22e">fake</span>.<span style="color:#a6e22e">callCount</span>.<span style="color:#a6e22e">should</span>.<span style="color:#a6e22e">eq</span>(<span style="color:#ae81ff">1</span>);
  });

  <span style="color:#a6e22e">it</span>(<span style="color:#e6db74">&#34;fake&#34;</span>, () =&gt; {
    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">fake</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">sinon</span>.<span style="color:#a6e22e">fake</span>.<span style="color:#a6e22e">returns</span>(<span style="color:#e6db74">&#34;foo&#34;</span>);
    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">result</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">fake</span>();
    <span style="color:#a6e22e">result</span>.<span style="color:#a6e22e">should</span>.<span style="color:#a6e22e">eq</span>(<span style="color:#e6db74">&#34;foo&#34;</span>);
  });

  <span style="color:#a6e22e">it</span>(<span style="color:#e6db74">&#34;replace&#34;</span>, () =&gt; {
    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">fake</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">sinon</span>.<span style="color:#a6e22e">fake</span>.<span style="color:#a6e22e">returns</span>(<span style="color:#e6db74">&#34;42&#34;</span>);
    <span style="color:#a6e22e">sinon</span>.<span style="color:#a6e22e">replace</span>(<span style="color:#a6e22e">console</span>, <span style="color:#e6db74">&#34;dir&#34;</span>, <span style="color:#a6e22e">fake</span>);
    <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">dir</span>(<span style="color:#e6db74">&#34;apple pie&#34;</span>).<span style="color:#a6e22e">should</span>.<span style="color:#a6e22e">be</span>.<span style="color:#a6e22e">eq</span>(<span style="color:#e6db74">&#34;42&#34;</span>);
  });

  <span style="color:#a6e22e">it</span>(<span style="color:#e6db74">&#34;spy function&#34;</span>, () =&gt; {
    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">foo</span> <span style="color:#f92672">=</span> () =&gt; <span style="color:#e6db74">&#34;foo&#34;</span>;
    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">spy</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">sinon</span>.<span style="color:#a6e22e">spy</span>(<span style="color:#a6e22e">foo</span>);
    <span style="color:#a6e22e">spy</span>();
    <span style="color:#a6e22e">spy</span>.<span style="color:#a6e22e">called</span>.<span style="color:#a6e22e">should</span>.<span style="color:#a6e22e">eq</span>(<span style="color:#66d9ef">true</span>);
  });

  <span style="color:#a6e22e">it</span>(<span style="color:#e6db74">&#34;spy object&#34;</span>, () =&gt; {
    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">foo</span> <span style="color:#f92672">=</span> {
      <span style="color:#a6e22e">bar</span><span style="color:#f92672">:</span> () =&gt; <span style="color:#e6db74">&#34;bar&#34;</span>
    };

    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">spy</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">sinon</span>.<span style="color:#a6e22e">spy</span>(<span style="color:#a6e22e">foo</span>, <span style="color:#e6db74">&#34;bar&#34;</span>);
    <span style="color:#a6e22e">foo</span>.<span style="color:#a6e22e">bar</span>();
    <span style="color:#a6e22e">spy</span>.<span style="color:#a6e22e">called</span>.<span style="color:#a6e22e">should</span>.<span style="color:#a6e22e">eq</span>(<span style="color:#66d9ef">true</span>);
  });

  <span style="color:#a6e22e">it</span>(<span style="color:#e6db74">&#34;stub&#34;</span>, () =&gt; {
    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">stub</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">sinon</span>.<span style="color:#a6e22e">stub</span>();
    <span style="color:#a6e22e">stub</span>(<span style="color:#e6db74">&#34;hello&#34;</span>);
    <span style="color:#a6e22e">stub</span>.<span style="color:#a6e22e">firstCall</span>.<span style="color:#a6e22e">args</span>[<span style="color:#ae81ff">0</span>].<span style="color:#a6e22e">should</span>.<span style="color:#a6e22e">eq</span>(<span style="color:#e6db74">&#34;hello&#34;</span>);
  });

  <span style="color:#a6e22e">it</span>(<span style="color:#e6db74">&#34;mock model&#34;</span>, <span style="color:#a6e22e">async</span> () =&gt; {
    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">expects</span> <span style="color:#f92672">=</span> [{ <span style="color:#a6e22e">name</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;foo&#34;</span> }, { <span style="color:#a6e22e">name</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;bar&#34;</span> }];

    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">Company</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">mongoose</span>.<span style="color:#a6e22e">model</span>(<span style="color:#e6db74">&#34;Company&#34;</span>);
    <span style="color:#a6e22e">sinon</span>.<span style="color:#a6e22e">mock</span>(<span style="color:#a6e22e">Company</span>).<span style="color:#a6e22e">expects</span>(<span style="color:#e6db74">&#34;find&#34;</span>).<span style="color:#a6e22e">resolves</span>(<span style="color:#a6e22e">expects</span>);
    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">result</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">await</span> <span style="color:#a6e22e">Company</span>.<span style="color:#a6e22e">find</span>({});
    <span style="color:#a6e22e">result</span>.<span style="color:#a6e22e">length</span>.<span style="color:#a6e22e">should</span>.<span style="color:#a6e22e">eq</span>(<span style="color:#ae81ff">2</span>);
    <span style="color:#a6e22e">result</span>[<span style="color:#ae81ff">0</span>].<span style="color:#a6e22e">name</span>.<span style="color:#a6e22e">should</span>.<span style="color:#a6e22e">eq</span>(<span style="color:#e6db74">&#34;foo&#34;</span>);
    <span style="color:#a6e22e">result</span>[<span style="color:#ae81ff">1</span>].<span style="color:#a6e22e">name</span>.<span style="color:#a6e22e">should</span>.<span style="color:#a6e22e">eq</span>(<span style="color:#e6db74">&#34;bar&#34;</span>);
  });

  <span style="color:#a6e22e">it</span>(<span style="color:#e6db74">&#34;stub function&#34;</span>, <span style="color:#a6e22e">async</span> () =&gt; {
    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">hello</span> <span style="color:#f92672">=</span> {
      <span style="color:#a6e22e">foo</span><span style="color:#f92672">:</span> () =&gt; <span style="color:#e6db74">&#34;foo&#34;</span>,
      <span style="color:#a6e22e">bar</span><span style="color:#f92672">:</span> (<span style="color:#a6e22e">arg</span>) =&gt; <span style="color:#a6e22e">arg</span>
    };

    <span style="color:#a6e22e">sinon</span>.<span style="color:#a6e22e">stub</span>(<span style="color:#a6e22e">hello</span>, <span style="color:#e6db74">&#39;foo&#39;</span>).<span style="color:#a6e22e">returns</span>(<span style="color:#e6db74">&#34;MOCK-VALUE&#34;</span>);
    <span style="color:#a6e22e">sinon</span>.<span style="color:#a6e22e">stub</span>(<span style="color:#a6e22e">hello</span>, <span style="color:#e6db74">&#39;bar&#39;</span>).<span style="color:#a6e22e">withArgs</span>(<span style="color:#e6db74">&#34;kk&#34;</span>).<span style="color:#a6e22e">returns</span>(<span style="color:#e6db74">&#34;&gt;&gt;&gt;&#34;</span>);

    <span style="color:#a6e22e">debug</span>(<span style="color:#a6e22e">hello</span>.<span style="color:#a6e22e">foo</span>());
    <span style="color:#a6e22e">debug</span>(<span style="color:#a6e22e">hello</span>.<span style="color:#a6e22e">bar</span>(<span style="color:#e6db74">&#39;kk&#39;</span>));
    <span style="color:#a6e22e">debug</span>(<span style="color:#a6e22e">hello</span>.<span style="color:#a6e22e">bar</span>(<span style="color:#e6db74">&#39;xyz&#39;</span>));
  });

  <span style="color:#75715e">// resolves: 返回Promise
</span><span style="color:#75715e"></span>  <span style="color:#75715e">// returns: 直接返回value
</span><span style="color:#75715e"></span>  <span style="color:#a6e22e">it</span>(<span style="color:#e6db74">&#34;mock args&#34;</span>, <span style="color:#a6e22e">async</span> () =&gt; {
    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">hello</span> <span style="color:#f92672">=</span> {
      <span style="color:#a6e22e">foo</span><span style="color:#f92672">:</span> () =&gt; <span style="color:#e6db74">&#34;foo&#34;</span>,
      <span style="color:#a6e22e">bar</span><span style="color:#f92672">:</span> (<span style="color:#a6e22e">arg</span>) =&gt; <span style="color:#a6e22e">arg</span>
    };

    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">mock</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">sinon</span>.<span style="color:#a6e22e">mock</span>(<span style="color:#a6e22e">hello</span>);
    <span style="color:#a6e22e">mock</span>.<span style="color:#a6e22e">expects</span>(<span style="color:#e6db74">&#34;foo&#34;</span>).<span style="color:#a6e22e">returns</span>(<span style="color:#e6db74">&#34;mock-foo&#34;</span>);
    <span style="color:#a6e22e">mock</span>.<span style="color:#a6e22e">expects</span>(<span style="color:#e6db74">&#34;bar&#34;</span>).<span style="color:#a6e22e">withArgs</span>(<span style="color:#e6db74">&#34;hello&#34;</span>).<span style="color:#a6e22e">returns</span>(<span style="color:#e6db74">&#34;HELLO&#34;</span>);

    <span style="color:#a6e22e">debug</span>(<span style="color:#a6e22e">hello</span>.<span style="color:#a6e22e">foo</span>());
    <span style="color:#a6e22e">debug</span>(<span style="color:#a6e22e">hello</span>.<span style="color:#a6e22e">bar</span>(<span style="color:#e6db74">&#39;hello&#39;</span>));
    <span style="color:#a6e22e">debug</span>(<span style="color:#a6e22e">hello</span>.<span style="color:#a6e22e">bar</span>(<span style="color:#e6db74">&#39;world&#39;</span>));
  });

  <span style="color:#a6e22e">afterEach</span>(() =&gt; {
    <span style="color:#a6e22e">sinon</span>.<span style="color:#a6e22e">restore</span>();
  });
});
</code></pre></div><p>参考:</p>
<ul>
<li><a href="https://www.zcfy.cc/article/mongoose-models-and-unit-tests-the-definitive-guide-codeutopia">Mongoose 单元测试: 权威指南| CodeUtopia - 众成翻译</a></li>
</ul>

</article>


<section class="post-nav">
    <ul>
        
        <li>
            <a href="http://nonocast.cn/posts/reading-list/"><i class="fa fa-chevron-circle-left"></i> Reading list</a>
        </li>
        
        
        <li>
            <a href="http://nonocast.cn/posts/hello-git/">Hello Git <i class="fa fa-chevron-circle-right"></i> </a>
        </li>
        
    </ul>
</section>
    
    





</main>
    <footer>
        <h6> |
            Rendered by <a href="https://gohugo.io" title="Hugo">Hugo</a> |
            <a href="http://nonocast.cn/index.xml">Subscribe </a></h6>
    </footer>
</div>
<script src="/js/scripts.js"></script>

</body>

</html>

